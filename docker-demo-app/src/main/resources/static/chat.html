<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DeepSeek Chat Demo</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f6fb; }
    
    /* Main layout */
    .container { display: flex; height: 100vh; }
    
    /* Sidebar styles */
    .sidebar {
      width: 280px;
      background: #fff;
      border-right: 1px solid #e6e6ef;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #e6e6ef;
    }
    .new-chat-btn {
      width: 100%;
      padding: 12px 16px;
      background: #4b7bec;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .new-chat-btn:hover { background: #3867d6; }
    .session-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .session-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.2s;
    }
    .session-item:hover { background: #f4f6fb; }
    .session-item.active { background: #e8f2ff; }
    .session-info { flex: 1; min-width: 0; }
    .session-title {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }
    .session-time {
      font-size: 12px;
      color: #888;
    }
    .session-actions {
      display: none;
      gap: 4px;
    }
    .session-item:hover .session-actions { display: flex; }
    .session-action-btn {
      padding: 4px 8px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 12px;
      color: #666;
      border-radius: 4px;
    }
    .session-action-btn:hover { background: #e6e6ef; }
    .session-action-btn.delete:hover { background: #ffe6e6; color: #d63031; }
</style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <button class="new-chat-btn" id="newChatBtn">
          <span>+</span> 新建会话
        </button>
      </div>
      <div class="session-list" id="sessionList">
        <!-- Sessions will be loaded here -->
      </div>
    </div>

    <!-- Main chat area -->
    <div class="main-content">
      <div class="chat-header">
        <h1 id="chatTitle">DeepSeek 聊天示例</h1>
        <div class="tip">提示词与背景在后端配置，如需修改请更新服务端配置。</div>
        <label class="tip"><input type="checkbox" id="keepContext" checked> 保留上下文对话历史</label>
      </div>
      <div class="chat-box" id="chatBox"></div>
      <div class="input-area">
        <div class="input-row">
          <textarea id="message" placeholder="输入问题后点击发送..."></textarea>
          <button id="sendBtn">发送</button>
        </div>
        <div class="tip">提示：API Key 从服务端读取，请在服务端配置环境变量 DEEPSEEK_API_KEY。</div>
      </div>
    </div>
  </div>

  <!-- Edit title modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-header">编辑会话标题</div>
      <input type="text" id="editTitleInput" class="modal-input" placeholder="输入新标题">
      <div class="modal-actions">
        <button class="modal-btn cancel" id="cancelEditBtn">取消</button>
        <button class="modal-btn confirm" id="confirmEditBtn">确认</button>
      </div>
    </div>
  </div>

  <style>
    /* Main content styles */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: 0 auto;
      padding: 24px 16px 32px;
      width: 100%;
    }
    .chat-header { margin-bottom: 16px; }
    .chat-header h1 { margin: 0 0 8px; font-size: 22px; }
    .chat-box {
      flex: 1;
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      min-height: 320px;
      overflow-y: auto;
    }
    .msg {
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      max-width: 88%;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .user { background: #e8f2ff; margin-left: auto; border: 1px solid #d5e6ff; }
    .bot { background: #f7f7f9; border: 1px solid #e6e6ef; }
    .input-area { margin-top: 14px; }
    .input-row { display: flex; gap: 10px; }
    textarea {
      flex: 1;
      resize: vertical;
      min-height: 56px;
      max-height: 180px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d0d7e2;
      font-size: 14px;
    }
    button {
      padding: 12px 18px;
      background: #4b7bec;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    button:disabled { background: #9fb7ff; cursor: not-allowed; }
    .tip { color: #666; font-size: 12px; margin-top: 8px; }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      width: 400px;
      max-width: 90%;
    }
    .modal-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .modal-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d0d7e2;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .modal-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .modal-btn.cancel {
      background: #f4f6fb;
      color: #333;
    }
    .modal-btn.confirm {
      background: #4b7bec;
      color: #fff;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container { flex-direction: column; }
      .sidebar {
        width: 100%;
        height: auto;
        max-height: 200px;
        border-right: none;
        border-bottom: 1px solid #e6e6ef;
      }
      .session-list { max-height: 120px; }
      .main-content { padding: 16px 12px 24px; }
      .chat-box { min-height: 260px; }
    }
  </style>

  <script>
    // DOM elements
    const chatBox = document.getElementById('chatBox');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('message');
    const keepContextInput = document.getElementById('keepContext');
    const sessionList = document.getElementById('sessionList');
    const newChatBtn = document.getElementById('newChatBtn');
    const chatTitle = document.getElementById('chatTitle');
    const editModal = document.getElementById('editModal');
    const editTitleInput = document.getElementById('editTitleInput');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const confirmEditBtn = document.getElementById('confirmEditBtn');

    // State
    let currentSessionId = null;
    let history = [];
    let editingSessionId = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadSessions();
    });

    // ==================== Session List Functions (9.1) ====================
    
    async function loadSessions() {
      try {
        const res = await fetch('/api/chat/sessions');
        if (!res.ok) throw new Error('Failed to load sessions');
        const sessions = await res.json();
        renderSessionList(sessions);
      } catch (err) {
        console.error('Error loading sessions:', err);
      }
    }

    function renderSessionList(sessions) {
      sessionList.innerHTML = '';
      sessions.forEach(session => {
        const item = document.createElement('div');
        item.className = `session-item${session.id === currentSessionId ? ' active' : ''}`;
        item.dataset.id = session.id;
        item.innerHTML = `
          <div class="session-info" onclick="switchSession('${session.id}')">
            <div class="session-title">${escapeHtml(session.title || '新会话')}</div>
            <div class="session-time">${formatTime(session.updateTime)}</div>
          </div>
          <div class="session-actions">
            <button class="session-action-btn" onclick="editSession('${session.id}', '${escapeHtml(session.title || '')}')">编辑</button>
            <button class="session-action-btn delete" onclick="deleteSession('${session.id}')">删除</button>
          </div>
        `;
        sessionList.appendChild(item);
      });
    }

    function formatTime(timeStr) {
      if (!timeStr) return '';
      const date = new Date(timeStr);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return '刚刚';
      if (diff < 3600000) return Math.floor(diff / 60000) + '分钟前';
      if (diff < 86400000) return Math.floor(diff / 3600000) + '小时前';
      if (diff < 604800000) return Math.floor(diff / 86400000) + '天前';
      
      return date.toLocaleDateString('zh-CN');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // New chat button
    newChatBtn.addEventListener('click', () => {
      startNewChat();
    });

    function startNewChat() {
      currentSessionId = null;
      history = [];
      chatBox.innerHTML = '';
      chatTitle.textContent = 'DeepSeek 聊天示例';
      updateActiveSession();
    }

    function updateActiveSession() {
      document.querySelectorAll('.session-item').forEach(item => {
        item.classList.toggle('active', item.dataset.id === currentSessionId);
      });
    }

    // ==================== Session Switch Functions (9.2) ====================
    
    async function switchSession(sessionId) {
      if (sessionId === currentSessionId) return;
      
      try {
        const res = await fetch(`/api/chat/sessions/${sessionId}`);
        if (!res.ok) throw new Error('Failed to load session');
        const session = await res.json();
        
        currentSessionId = sessionId;
        chatTitle.textContent = session.title || '新会话';
        
        // Clear chat box and load messages for display only
        chatBox.innerHTML = '';
        history = []; // 清空本地history，后端会从数据库加载
        
        if (session.messages && session.messages.length > 0) {
          session.messages.forEach(msg => {
            appendMessage(msg.content, msg.role);
            // 不再维护本地history，因为后端会从数据库加载
          });
        }
        
        updateActiveSession();
      } catch (err) {
        console.error('Error switching session:', err);
        alert('加载会话失败：' + err.message);
      }
    }

    // ==================== Session Management Functions (9.3) ====================
    
    async function deleteSession(sessionId) {
      if (!confirm('确定要删除这个会话吗？')) return;
      
      try {
        const res = await fetch(`/api/chat/sessions/${sessionId}`, {
          method: 'DELETE'
        });
        if (!res.ok) throw new Error('Failed to delete session');
        
        // If deleting current session, start new chat
        if (sessionId === currentSessionId) {
          startNewChat();
        }
        
        // Reload session list
        loadSessions();
      } catch (err) {
        console.error('Error deleting session:', err);
        alert('删除会话失败：' + err.message);
      }
    }

    function editSession(sessionId, currentTitle) {
      editingSessionId = sessionId;
      editTitleInput.value = currentTitle;
      editModal.classList.add('show');
      editTitleInput.focus();
    }

    cancelEditBtn.addEventListener('click', () => {
      editModal.classList.remove('show');
      editingSessionId = null;
    });

    confirmEditBtn.addEventListener('click', async () => {
      const newTitle = editTitleInput.value.trim();
      if (!newTitle) {
        alert('标题不能为空');
        return;
      }
      
      try {
        const res = await fetch(`/api/chat/sessions/${editingSessionId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: newTitle })
        });
        if (!res.ok) throw new Error('Failed to update title');
        
        // Update title if editing current session
        if (editingSessionId === currentSessionId) {
          chatTitle.textContent = newTitle;
        }
        
        editModal.classList.remove('show');
        editingSessionId = null;
        loadSessions();
      } catch (err) {
        console.error('Error updating title:', err);
        alert('更新标题失败：' + err.message);
      }
    });

    // Close modal on overlay click
    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) {
        editModal.classList.remove('show');
        editingSessionId = null;
      }
    });

    // ==================== Send Message Functions (9.4) ====================
    
    function appendMessage(text, role) {
      const div = document.createElement('div');
      div.className = `msg ${role === 'user' ? 'user' : 'bot'}`;
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function send() {
      const text = messageInput.value.trim();
      if (!text) return;
      messageInput.value = '';
      appendMessage(text, 'user');
      setLoading(true);
      
      try {
        const requestBody = {
          message: text
        };
        
        // 如果有sessionId，后端会从数据库加载历史，不需要发送history
        // 如果没有sessionId且勾选了保留上下文，才发送本地history
        if (currentSessionId) {
          requestBody.sessionId = currentSessionId;
          // 不发送history，后端从数据库加载
        } else if (keepContextInput.checked && history.length > 0) {
          requestBody.history = history;
        }
        
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        if (!res.ok) {
          const msg = await res.text();
          throw new Error(msg || res.statusText);
        }
        
        const data = await res.json();
        const botMsg = data.reply || '（未获取到回复）';
        appendMessage(botMsg, 'bot');
        
        // Update sessionId if returned (new session created)
        if (data.sessionId && !currentSessionId) {
          currentSessionId = data.sessionId;
          // Reload sessions to show the new one
          loadSessions();
          // Update title with first message
          const title = text.length > 20 ? text.substring(0, 20) + '...' : text;
          chatTitle.textContent = title;
        }
        
        if (keepContextInput.checked) {
          history.push({ role: 'user', content: text });
          history.push({ role: 'assistant', content: botMsg });
        } else {
          history = [];
        }
      } catch (err) {
        appendMessage('出错了：' + err.message, 'bot');
      } finally {
        setLoading(false);
      }
    }

    function setLoading(loading) {
      sendBtn.disabled = loading;
      sendBtn.textContent = loading ? '发送中...' : '发送';
    }

    sendBtn.addEventListener('click', send);
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
  </script>
</body>
</html>
